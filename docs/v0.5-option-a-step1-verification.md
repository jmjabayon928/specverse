# Option A Step 1 â€” Verification (SystemRevision dual-write + ordering)

## Commands to run tests

```bash
# Revision-related tests only
npx jest tests/services/filledSheetUpdateUpsert.test.ts tests/api/sheetRevisions.test.ts --no-cache

# Full test suite (optional)
npm test
```

## SQL queries to sanity-check in DB (no new migrations)

Assume `DataSheets` database and existing `SheetRevisions` rows. Run after creating/updating a filled sheet (save) so at least one new revision row exists.

1. **New rows have SystemRevisionNum and SystemRevisionAt populated (and legacy dual-written):**
   ```sql
   SELECT TOP 5
     RevisionID, SheetID,
     SystemRevisionNum, SystemRevisionAt,
     RevisionNum, RevisionDate,
     CreatedByID, CreatedByDate
   FROM dbo.SheetRevisions
   ORDER BY SheetID, COALESCE(SystemRevisionNum, RevisionNum) DESC;
   ```
   Expect: `SystemRevisionNum` and `SystemRevisionAt` set; `RevisionNum` = `SystemRevisionNum`; `RevisionDate` = date part of `SystemRevisionAt`/`CreatedByDate`.

2. **Ordering by system revision (list semantics):**
   ```sql
   SELECT RevisionID, SheetID,
          COALESCE(SystemRevisionNum, RevisionNum) AS OrderNum,
          SystemRevisionNum, RevisionNum
   FROM dbo.SheetRevisions
   WHERE SheetID = @SheetID  -- substitute a real SheetID
   ORDER BY COALESCE(SystemRevisionNum, RevisionNum) DESC;
   ```
   Expect: Same order as API list revisions; `OrderNum` strictly decreasing for that sheet.

3. **Next number would use MAX(SystemRevisionNum) + 1:**
   ```sql
   SELECT SheetID,
          ISNULL(MAX(COALESCE(SystemRevisionNum, RevisionNum)), 0) + 1 AS NextNum
   FROM dbo.SheetRevisions
   WHERE SheetID = @SheetID  -- substitute a real SheetID
   GROUP BY SheetID;
   ```
   Expect: `NextNum` = current max + 1 for that sheet.
