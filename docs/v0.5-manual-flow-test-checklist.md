# SpecVerse v0.5 — Manual Flow Test Checklist + Bug Capture Plan

**Branch:** fix/v0.5-stabilization  
**Purpose:** Run manual end-to-end test pass of the datasheet flow and capture bugs systematically. Do NOT implement fixes from this doc until approved.

---

## A) Checklist Table

| Step # | Page (URL pattern) | Action | Expected result |
|--------|--------------------|--------|-----------------|
| 1 | `/datasheets/templates` | Load page | List renders; filters (category, discipline, subtype, user, date) work; no crash |
| 1b | Same | Change filters / pagination (if any) | Results update; no empty flash or stale data |
| 2 | `/datasheets/templates/create` | Create template: fill metadata, add subsheets, add info templates; submit | 201; redirect to `/datasheets/templates/{id}`; notifications non-fatal if they fail |
| 3 | `/datasheets/templates/{id}/edit` | Edit template (must be Draft) | Save succeeds; status remains Draft or becomes Modified Draft per backend |
| 4 | `/datasheets/templates/{id}/verify` | Verify: click Verify | 200; status → Verified; redirect |
| 4b | Same | Reject: enter comment, click Reject | 200; status → Rejected; rejection comment required (client + server) |
| 5 | `/datasheets/templates/{id}/approve` | Approve (only when Verified) | 200; status → Approved; redirect |
| 5b | Same | Try approve when Draft | 409; message indicates "only be approved when status is Verified" |
| 6 | `/datasheets/filled/create?templateId={id}` | Create filled sheet from Approved template (template must be Approved + IsLatest) | 201; new sheet Draft; editable: instance metadata + info values; template structure locked |
| 6b | Same | Try create from Draft template | 409; message about approved template / latest version |
| 7 | `/datasheets/filled/{id}/edit` | Edit filled sheet (must be Draft / Modified Draft / Rejected) | Save succeeds; status editable only when allowed |
| 7b | Same | Try edit when Approved | 409; message "only be edited when status is Draft, Modified Draft, or Rejected" |
| 8 | `/datasheets/filled/{id}/verify` | Verify filled sheet | 200; status → Verified (or Rejected with comment) |
| 9 | `/datasheets/filled/{id}/approve` | Approve filled sheet (only when Verified) | 200; status → Approved |
| 10 | `/datasheets/filled/{id}/clone` | Clone filled sheet: new tag, project; submit | 201; new sheet created; clone binds to **latest approved template** (not necessarily source TemplateID); ParentSheetID = NULL, Status = Draft |
| 10b | Same | Clone when no latest approved in chain | 409; clear message (e.g. "No latest approved template in chain") |
| 11 | `/datasheets/filled/{id}/revisions` | Open revisions list | List loads; snapshot-based; no mutation of history |
| 11b | Same | Restore revision (if offered) | Restore uses snapshot; does not corrupt chain; 200/201 as designed |

---

## B) Likely Causes Mapping (Known Symptoms)

### Lists empty / not rendering

| Symptom | Where to look | Likely cause |
|---------|----------------|---------------|
| Templates list empty | `GET /api/backend/templates` → [templateController](src/backend/controllers/templateController.ts) → [fetchAllTemplates](src/backend/services/templateService.ts) | DB: `IsTemplate = 1` filter; no rows; or auth/permission blocking |
| Filled list empty | `GET /api/backend/filledsheets` → [filledSheetController](src/backend/controllers/filledSheetController.ts) → [fetchAllFilled](src/backend/services/filledSheetService.ts) | DB: `IsTemplate = 0` filter; or auth |
| Filters not applied | [templates page](src/app/(admin)/datasheets/templates/page.tsx) (client-side filter on `templates`) | Data loaded but filter state/categoryId/disciplineId mismatch |
| Revisions list empty | `GET /api/backend/filledsheets/:id/revisions` → [sheetRevisionController](src/backend/controllers/sheetRevisionController.ts) → [sheetRevisionQueries](src/backend/database/sheetRevisionQueries.ts) | No rows in SheetRevisions for that SheetID; or route/param wrong |

**Logs:** Server stdout (e.g. `console.error` in [errorHandler](src/backend/middleware/errorHandler.ts)); browser Network tab for status and response body.

---

### 409 errors post-guardrails

| Symptom | Where to look | Likely cause |
|---------|----------------|---------------|
| 409 on **edit template** | [updateTemplate](src/backend/services/templateService.ts) | Status not in {Draft, Modified Draft, Rejected}; message: "Template can only be edited when status is..." |
| 409 on **verify template** | [verifyTemplate](src/backend/services/templateService.ts) | Status not Draft/Modified Draft; message: "only be verified or rejected when status is Draft or Modified Draft" |
| 409 on **approve template** | [approveTemplate](src/backend/services/templateService.ts) | Status not Verified; message: "only be approved when status is Verified" |
| 409 on **create filled sheet** | [createFilledSheet](src/backend/services/filledSheetService.ts) | Template not Approved, or not IsLatest, or not template; message mentions "approved template" / "latest version" |
| 409 on **edit filled sheet** | [updateFilledSheet](src/backend/services/filledSheetService.ts) | Sheet status not Draft/Modified Draft/Rejected; message "only be edited when status is..." |
| 409 on **verify filled sheet** | [verifyFilledSheet](src/backend/services/filledSheetService.ts) | Status not Draft/Modified Draft |
| 409 on **approve filled sheet** | [approveFilledSheet](src/backend/services/filledSheetService.ts) | Status not Verified |
| 409 on **clone filled sheet** | [cloneFilledSheetHandler](src/backend/controllers/filledSheetController.ts) → [getLatestApprovedTemplateId](src/backend/services/filledSheetService.ts) | No latest approved in chain; multiple latest; cycle; or source not a template |

**Logs:** Response body has `error` / `message`; server logs the thrown `AppError` in development ([errorHandler](src/backend/middleware/errorHandler.ts)).

---

### Translation missing labels

| Symptom | Where to look | Likely cause |
|---------|----------------|---------------|
| Filled sheet / template labels in wrong language or missing | [getSheetTranslations](src/backend/services/translationService.ts); [applySheetTranslations](src/utils/applySheetTranslations.ts) | Filled sheet uses template’s translations (TemplateID → baseSheetId); no rows in SheetTranslations / SubsheetTranslations / InfoTemplateTranslations for that lang |
| Create-filled or clone form: subsheet/field labels empty | Same + [FilledSheetCreatorForm](src/app/(admin)/datasheets/filled/create/FilledSheetCreatorForm.tsx) | Translations not generated for template (plan: only on template approve); or lang param not passed |

**Logs:** Optional `console.log` in [translationService](src/backend/services/translationService.ts) (sheetId, baseSheetId); Network response for template/filled detail including `translations`.

---

## C) Proposed Fix Queue (Prioritized)

Do **not** implement until approved. Each fix should be minimal and paired with a test.

| Priority | Issue (hypothesis) | Proposed minimal fix | Where |
|----------|--------------------|-----------------------|--------|
| P1 | UI allows "Edit" on Approved template → user hits 409 | Option A: Disable Edit when status not Draft/Modified Draft/Rejected (already in [TemplateActions](src/components/datasheets/templates/TemplateActions.tsx)). Option B: On 409 from PUT, show `res.body.message` in toast/alert | Frontend: Template detail/edit; error handling for updateTemplate |
| P1 | UI allows "Approve" when not Verified → 409 | Same as above: disable Approve unless Verified (already in [TemplateActions](src/components/datasheets/templates/TemplateActions.tsx)); surface 409 message if bypassed | Frontend: Approve button; error handler |
| P1 | Create filled from non-Approved template → 409 | Ensure "Create filled" only offered for Approved templates (already in [TemplateActions](src/components/datasheets/templates/TemplateActions.tsx)); create page should receive only Approved templateId; backend already enforces | Frontend: create flow; Backend: already guarded |
| P2 | Edit filled when Approved → 409 | Disable Edit when status not Draft/Modified Draft/Rejected ([FilledSheetActions](src/components/datasheets/filled/FilledSheetActions.tsx)); on PUT 409 show message | Frontend: FilledSheetActions; edit error handling |
| P2 | Clone returns 409 (no latest approved / multiple latest) | Show API `message` in clone form; no backend change if resolver is correct | Frontend: [FilledSheetClonerForm](src/app/(admin)/datasheets/filled/[id]/clone/FilledSheetClonerForm.tsx) |
| P2 | Revisions restore or list fails | Confirm [sheetRevisionController](src/backend/controllers/sheetRevisionController.ts) and [sheetRevisionQueries](src/backend/database/sheetRevisionQueries.ts) match DB schema (SheetRevisions); restore uses updateFilledSheet with skipRevisionCreation | Backend: revision restore flow; tests: sheetRevisions.test.ts |
| P3 | Translation labels missing on create-filled | Document that translations are on-demand (mirror) or add hook on template approve to seed translations; no schema change | Backend: optional hook in approveTemplate; or doc only |
| P3 | STRING_SPLIT for chain IDs fails on older SQL Server | Fallback: build IN list with dynamic params or temp table if STRING_SPLIT unavailable | [getLatestApprovedTemplateId](src/backend/services/filledSheetService.ts) |

---

## D) Suggested Test Type per Fix

| Fix (from C) | Suggested test type | Where / what |
|--------------|---------------------|--------------|
| P1 409 on edit/approve template | Already covered: [templateService.test.ts](tests/services/templateService.test.ts) (updateTemplate 409, verifyTemplate 409, approveTemplate 409) | Service |
| P1 Create filled from non-Approved | Already covered: [filledSheetLifecycleGuards.test.ts](tests/services/filledSheetLifecycleGuards.test.ts) (createFilledSheet 409 when not Approved / not IsLatest) | Service |
| P2 Edit filled when Approved | Already covered: [filledSheetUpdateUpsert.test.ts](tests/services/filledSheetUpdateUpsert.test.ts) (updateFilledSheet 409 when Approved) | Service |
| P2 Clone 409 | Already covered: [filledSheetClone.test.ts](tests/api/filledSheetClone.test.ts) (409 when getLatestApprovedTemplateId throws) | API |
| P2 Revisions restore | Add or extend: [sheetRevisions.test.ts](tests/api/sheetRevisions.test.ts) — restore does not mutate history; list returns snapshots | API |
| P3 Translations | Optional: API or service test that getSheetTranslations returns structure for template/filled; or doc-only | API / Service |
| P3 STRING_SPLIT fallback | Service test: getLatestApprovedTemplateId with chain length > N (if fallback added) | Service |

---

## Bug Capture Template (per bug)

For each bug found during the manual pass, fill:

- **Page URL:** (e.g. `/datasheets/templates/5/edit`)
- **Steps to reproduce:** (numbered)
- **Console error:** (browser console)
- **Network:** Method, URL, status, response body (JSON)
- **Server log:** (relevant line from backend stdout)
- **Expected vs actual:** (one line each)
- **Proposed minimal fix:** (file + 1–2 sentences)
- **Minimal test to prevent regression:** (service / API / UI; one sentence)

---

## Quick Reference: API Endpoints Used by Flow

| Action | Method | Endpoint |
|--------|--------|----------|
| List templates | GET | `/api/backend/templates` |
| Get template | GET | `/api/backend/templates/:id` |
| Create template | POST | `/api/backend/templates` |
| Update template | PUT | `/api/backend/templates/:id` |
| Verify template | POST | `/api/backend/templates/:id/verify` |
| Approve template | POST | `/api/backend/templates/:id/approve` |
| List filled | GET | `/api/backend/filledsheets` |
| Get filled | GET | `/api/backend/filledsheets/:id` |
| Create filled | POST | `/api/backend/filledsheets` |
| Update filled | PUT | `/api/backend/filledsheets/:id` |
| Verify filled | POST | `/api/backend/filledsheets/:id/verify` |
| Approve filled | POST | `/api/backend/filledsheets/:id/approve` |
| Clone filled | POST | `/api/backend/filledsheets/:id/clone` |
| List revisions | GET | `/api/backend/filledsheets/:id/revisions` |
| Restore revision | POST | `/api/backend/filledsheets/:id/revisions/:revisionId/restore` |
