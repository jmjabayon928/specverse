# v0.5 â€” Categories expansion verification + UX checks

**Branch:** fix/v0.5-stabilization  
**Scope:** Verify new seeded Categories appear everywhere; confirm persistence; discipline vs category UX (discovery + minimal guardrails).

---

## 1) Where categories appear (verified in code)

| Location | Source | Display |
|----------|--------|--------|
| `/datasheets/templates` | GET `/api/backend/templates/reference-options` | Filter dropdown + list column "Category" |
| `/datasheets/templates/create` | GET `/api/backend/references` | Category dropdown (id/name shape) |
| `/datasheets/templates/[id]/edit`, `[id]/clone` | Server `fetchReferenceOptions()` (ReferenceQueries) | Category dropdown |
| `/datasheets/filled` | GET `/api/backend/filledsheets/reference-options` | Filter dropdown + list column "Category" |
| `/datasheets/filled/create` | GET `/api/backend/filledsheets/reference-options` | Category dropdown (CategoryID/CategoryName; FE maps to options) |
| `/datasheets/filled/[id]/edit`, `[id]/clone` | Server `fetchReferenceOptions()` | Category dropdown |
| `/inventory` (list, create, edit) | Server `fetchReferenceOptions()` or GET `/api/backend/inventory/reference-options` | Category filter/dropdown (id/name) |

All use the same **Categories** table. After running `migrations/seed_categories_expansion.sql`, new categories (MECH, ELEC, INST, CIVIL, STRUCT, HVAC, PIPING) appear in all dropdowns and filters.

**Fix applied:** Filled create form expected `{ id, name }` but filled reference-options returns `{ CategoryID, CategoryName }`. Added `categoriesToOptions()` in `FilledSheetCreatorForm.tsx` to accept both shapes so the category dropdown works.

---

## 2) Persistence

- **Template create:** `categoryId` is required (sheetSchema); backend writes `Sheets.CategoryID`. List and detail APIs join `Categories` and return `categoryId` + `categoryName`.
- **Filled create:** User selects category (or inherits from template); backend writes `Sheets.CategoryID`. Filled list and detail return `categoryId` + `categoryName`.
- **Verification:** Create a template with category ELEC (Electrical), save. Confirm list shows "Electrical" and detail shows Category. Create a filled sheet from that template; confirm category displays and persists after save/reload.

---

## 3) Discipline vs category (discovery)

- **Categories:** Global. No FK to Disciplines. Table: `Categories(CategoryID, CategoryCode, CategoryName, ...)`. Used for equipment/type grouping across the app.
- **Subtype:** Discipline-scoped. `DatasheetSubtypes(SubtypeID, DisciplineID, ...)`. Subtype options are filtered by selected discipline in the UI.
- **No coupling in code:** Nothing prevents e.g. Category = Electrical and Discipline = PIPING. This is intentional (category = global label; discipline = engineering discipline).

**Possible UX confusion:** A user might think "Category" and "Discipline" should align (e.g. Electrical category + Electrical discipline). Today the UI does not enforce or suggest that.

**Minimal UX guardrail (optional):** On template create/edit, add a short hint near the Category and Discipline fields, e.g.  
*"Category is global (e.g. equipment type). Discipline and Subtype describe the engineering discipline."*  
No schema change; one line of helper text. Implement only if you want to reduce confusion.

---

## 4) Regression test

- **API:** `GET /api/backend/filledsheets/reference-options` returns `categories` with `CategoryID` and `CategoryName` so the filled create form dropdown works. See `tests/api/datasheets.filled.test.ts` (reference-options test updated to assert category shape).
