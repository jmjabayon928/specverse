# Phase 4A/4B/4C — UX polish, revision badges, revision snapshot guard

Summary of Phase 4 improvements (no DB or API contract changes).

## 4A — Clone UX hint

- **Where:** Filled-sheet clone page (`/datasheets/filled/[id]/clone`), top of `FilledSheetClonerForm`.
- **What:** Info banner (blue) with text:  
  *"Template structure and units (UOM) are inherited from the template. Cloning creates a new filled sheet; edit values and identity fields only."*
- **Verification:** Open clone page for a filled sheet; banner is visible. Test: `tests/ui/datasheets/FilledSheetClonerForm.test.tsx` — "renders clone UX hint about template structure and UOM inherited".

## 4B — Revision list "changed fields" badge

- **Where:** Revision History list (`/datasheets/filled/[id]/revisions`), `RevisionsListClient.tsx`.
- **What:** New column "Fields changed" with per-revision badge:
  - Revision #1: "—" (no previous).
  - Revision #2+: "—" until computed, then "N changed" (client-side diff vs previous snapshot).
- **How:** Uses existing APIs: list revisions, then for each revision with a previous one, fetch current and previous revision (GET by id), parse snapshots with `unifiedSheetSchema`, run `diffUnifiedSheets(prev, curr)` from `revisionDiff.ts`, count rows where `kind !== 'unchanged'`. Badges load lazily (current page only).
- **Verification:** Open Revision History for a sheet with ≥2 revisions; after load, rev #2+ show "N changed". Test: `tests/ui/datasheets/RevisionsListClient.test.tsx` — "shows Fields changed badge with correct count for revision 2 vs 1".

## 4C — Backend guard: revision snapshot must be valid UnifiedSheet

- **Where:** `src/backend/database/sheetRevisionQueries.ts` — `createRevision`.
- **What:** Before inserting a row, parse `snapshotJson` and validate with `unifiedSheetSchema.safeParse`. If invalid (bad JSON or not UnifiedSheet), throw:  
  *"Invalid revision snapshot: snapshotJson is not a UnifiedSheet"*  
  and do not run the INSERT.
- **Callers:** `updateFilledSheet` (first save creates revision), `restoreRevisionHandler` (restore creates new revision). Normal flows produce valid UnifiedSheet; guard fails fast on bad data.
- **Verification:** Unit test: `tests/api/sheetRevisionQueries.createRevision.test.ts` — invalid `snapshotJson` causes throw and `tx.request()` is not called.

## Verification commands

- `npm run lint`
- `npm run type-check` (or `npx tsc --noEmit`)
- `npm test`

## Constraints preserved

- No DB schema changes.
- No API contract changes (additive UI/fields only).
- create/clone does not create revisions; first save does. Restore still creates a new revision row after applying snapshot.
